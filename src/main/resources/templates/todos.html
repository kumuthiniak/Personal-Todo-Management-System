<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App with Notifications</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 70px;
        }
        #todocontainer {
            margin-top: 20px;
        }
        .navbar-text {
            color: white !important;
            margin-right: 15px;
        }
        .search-container {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #333;
                padding-bottom: 10px;
            }
            .card-header, .btn-group {
                display: none !important;
            }
            .table-responsive {
                overflow: visible !important;
            }
            body {
                font-size: 12pt;
                color: #000;
                padding-top: 0;
            }
            .badge {
                border: 1px solid #000;
                color: #000;
                background-color: transparent !important;
            }
            .table-striped tbody tr:nth-of-type(odd) {
                background-color: rgba(0, 0, 0, 0.05) !important;
            }
        }
        .print-header {
            display: none;
        }
        .print-info {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
        .priority-high {
            background-color: #ffcccc;
        }
        .priority-medium {
            background-color: #fff9cc;
        }
        .priority-low {
            background-color: #ccffcc;
        }
        .category-badge {
            margin-right: 5px;
        }
        .due-date {
            font-size: 0.85rem;
        }
        .overdue {
            color: #dc3545;
            font-weight: bold;
        }
        .notes-popover {
            cursor: pointer;
            color: #6c757d;
        }
        .additional-filters {
            margin-top: 10px;
        }
        
        /* Improved Notification styles */
        .notification-container {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1050;
            width: 320px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .notification-container.has-notifications {
            max-height: 300px;
        }
        
        .notification-item {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            margin-bottom: 12px;
            padding: 12px 16px;
            background: white;
            border-left: 4px solid #ffc107;
            animation: slideIn 0.3s ease-out;
            display: flex;
            justify-content: between;
            align-items: flex-start;
        }
        
        .notification-item.alert-danger {
            border-left-color: #dc3545;
        }
        
        .notification-item.alert-info {
            border-left-color: #17a2b8;
        }
        
        .notification-content {
            flex-grow: 1;
            margin-right: 10px;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }
        
        .notification-message {
            font-size: 0.85rem;
            margin-bottom: 0;
            color: #6c757d;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            line-height: 1;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
        }
        
        /* Animation for new notifications */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Make notifications less intrusive on mobile */
        @media (max-width: 768px) {
            .notification-container {
                left: 20px;
                right: 20px;
                width: auto;
            }
        }
        
        .todo-card {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .action-buttons {
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <!-- Improved Notification Container -->
    <div class="notification-container no-print" id="notificationContainer">
        <!-- Notifications will be dynamically added here -->
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark no-print fixed-top">
        <a class="navbar-brand" href="#">TODOS</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" 
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <span class="navbar-text">Welcome, User</span>
                </li>
                <li class="nav-item">
                    <button class="btn btn-outline-light btn-sm">Logout</button>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <section id="todocontainer">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <!-- Success/Error Messages -->
                    <div class="alert alert-success alert-dismissible fade show no-print" style="display: none;" id="successAlert">
                        Operation completed successfully!
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                    </div>
                    <div class="alert alert-danger alert-dismissible fade show no-print" style="display: none;" id="errorAlert">
                        Error occurred!
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                    </div>

                    <!-- Search and Filter Form -->
                    <div class="search-container no-print">
                        <form id="searchForm" class="form-inline">
                            <div class="form-group mr-2">
                                <input type="text" class="form-control" id="searchInput" name="search" 
                                    placeholder="Search todos..." onkeyup="filterTodos()">
                            </div>
                            <div class="form-group mr-2">
                                <select class="form-control" id="statusFilter" name="status" onchange="filterTodos()">
                                    <option value="all">All Statuses</option>
                                    <option value="Yes">Completed</option>
                                    <option value="No">Pending</option>
                                </select>
                            </div>
                            <div class="form-group mr-2">
                                <select class="form-control" id="priorityFilter" onchange="filterTodos()">
                                    <option value="all">All Priorities</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="form-group mr-2">
                                <select class="form-control" id="categoryFilter" onchange="filterTodos()">
                                    <option value="all">All Categories</option>
                                    <option value="Work">Work</option>
                                    <option value="Personal">Personal</option>
                                    <option value="Health">Health</option>
                                    <option value="Shopping">Shopping</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary mr-2" onclick="filterTodos()">Search</button>
                            <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                        </form>
                        
                        <div class="additional-filters form-inline mt-2">
                            <div class="form-group mr-2">
                                <input type="text" class="form-control" id="dueDateFilter" placeholder="Filter by due date" readonly>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="overdueFilter" onchange="filterTodos()">
                                <label class="form-check-label" for="overdueFilter">Show Overdue Only</label>
                            </div>
                        </div>
                    </div>

                    <!-- Print Header (only shows when printing) -->
                    <div class="print-header">
                        <h2>Todo List</h2>
                        <div class="print-info">
                            <strong>User:</strong> User | 
                            <strong>Date:</strong> <span id="printDate"></span>
                        </div>
                    </div>

                    <!-- Print Button -->
                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                        <h5>My Todos</h5>
                        <div>
                            <button class="btn btn-info btn-sm mr-2" onclick="printTodos()">
                                📄 Print Todos
                            </button>
                            <button class="btn btn-success btn-sm" data-toggle="modal" data-target="#addTodoModal">
                                + Add New Todo
                            </button>
                        </div>
                    </div>

                    <!-- Todos Table -->
                    <div class="card todo-card">
                        <div class="card-header d-flex justify-content-between align-items-center no-print">
                            <h5 class="mb-0">Todo List</h5>
                            <span class="badge badge-primary" id="todoCount">0 items</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th scope="col">ID</th>
                                            <th scope="col">Todo Item</th>
                                            <th scope="col">Priority</th>
                                            <th scope="col">Category</th>
                                            <th scope="col">Due Date</th>
                                            <th scope="col">Status</th>
                                            <th scope="col" class="no-print">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="todoTableBody">
                                        <!-- Sample todos will be added by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Add Todo Modal -->
    <div class="modal fade no-print" id="addTodoModal" tabindex="-1" role="dialog" aria-labelledby="addTodoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTodoModalLabel">Add New Todo</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addTodoForm">
                        <div class="form-group">
                            <label for="todoItem">Todo Item *</label>
                            <input type="text" class="form-control" id="todoItem" name="todoItem" 
                                placeholder="Enter your todo item" required>
                        </div>
                        <div class="form-group">
                            <label for="priority">Priority</label>
                            <select class="form-control" id="priority" name="priority">
                                <option value="High">High</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select class="form-control" id="category" name="category">
                                <option value="Work">Work</option>
                                <option value="Personal">Personal</option>
                                <option value="Health">Health</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Other" selected>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dueDate">Due Date</label>
                            <input type="text" class="form-control" id="dueDate" name="dueDate" 
                                placeholder="Select due date" readonly>
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" 
                                placeholder="Add any additional notes" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="status">Initial Status</label>
                            <select class="form-control" id="status" name="status">
                                <option value="No" selected>Pending</option>
                                <option value="Yes">Completed</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="addNewTodo()">Add Todo</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>
    
    <!-- Flatpickr for date selection -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Custom JavaScript -->
    <script>
        // Sample data for demonstration
        let todos = [
            { id: 1, todoItem: "Complete project proposal", priority: "High", category: "Work", dueDate: "2023-12-15", completed: "No", notes: "Send to manager for review" },
           ];
        
        let nextId = 6;
        
        // Initialize date pickers
        document.addEventListener('DOMContentLoaded', function() {
            // Due date in add modal
            flatpickr("#dueDate", {
                dateFormat: "Y-m-d",
                minDate: "today"
            });
            
            // Due date filter
            flatpickr("#dueDateFilter", {
                dateFormat: "Y-m-d",
                mode: "range",
                onChange: function(selectedDates, dateStr, instance) {
                    filterTodos();
                }
            });
            
            // Initialize popovers
            $('[data-toggle="popover"]').popover({
                trigger: 'hover',
                placement: 'top'
            });
            
            // Render initial todos
            renderTodos();
            
            // Initialize notifications
            initNotifications();
        });

        // Render todos to the table
        function renderTodos() {
            const tbody = document.getElementById('todoTableBody');
            tbody.innerHTML = '';
            
            if (todos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No todos found. Add your first todo!</td></tr>';
                document.getElementById('todoCount').textContent = '0 items';
                return;
            }
            
            todos.forEach(todo => {
                const row = document.createElement('tr');
                const dueDate = todo.dueDate ? new Date(todo.dueDate) : null;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const isOverdue = dueDate && dueDate < today && todo.completed === 'No';
                
                row.setAttribute('data-todo-item', todo.todoItem);
                row.setAttribute('data-status', todo.completed);
                row.setAttribute('data-priority', todo.priority);
                row.setAttribute('data-category', todo.category);
                row.setAttribute('data-due-date', todo.dueDate);
                row.setAttribute('data-notes', todo.notes);
                
                if (todo.completed === 'Yes') {
                    row.classList.add('table-success');
                }
                
                let dueDateText = '';
                if (dueDate) {
                    dueDateText = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                }
                
                row.innerHTML = `
                    <th scope="row">${todo.id}</th>
                    <td class="todo-item">${todo.todoItem} ${todo.notes ? '<span class="notes-popover" data-toggle="popover" data-content="' + todo.notes + '" title="Notes">📝</span>' : ''}</td>
                    <td>
                        <span class="badge ${todo.priority === 'High' ? 'badge-danger' : todo.priority === 'Medium' ? 'badge-warning' : 'badge-success'}">${todo.priority}</span>
                    </td>
                    <td>
                        ${todo.category ? `<span class="badge badge-info category-badge">${todo.category}</span>` : ''}
                    </td>
                    <td>
                        ${dueDate ? `<span class="due-date ${isOverdue ? 'overdue' : ''}">${dueDateText}</span>` : ''}
                    </td>
                    <td>
                        <span class="badge ${todo.completed === 'Yes' ? 'badge-success' : 'badge-warning'}">${todo.completed === 'Yes' ? 'Completed' : 'Pending'}</span>
                    </td>
                    <td class="no-print action-buttons">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleTodoStatus(${todo.id})">
                                ${todo.completed === 'No' ? 'Mark Complete' : 'Mark Incomplete'}
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteTodo(${todo.id})">
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('todoCount').textContent = todos.length + ' items';
            
            // Update notifications
            updatePendingCount();
            checkForOverdueTodos();
        }
        
        // Add a new todo
        function addNewTodo() {
            const todoItem = document.getElementById('todoItem').value;
            const priority = document.getElementById('priority').value;
            const category = document.getElementById('category').value;
            const dueDate = document.getElementById('dueDate').value;
            const notes = document.getElementById('notes').value;
            const status = document.getElementById('status').value;
            
            if (!todoItem) {
                showNotification('Error', 'Todo item is required!', 'danger');
                return;
            }
            
            const newTodo = {
                id: nextId++,
                todoItem,
                priority,
                category,
                dueDate,
                completed: status,
                notes
            };
            
            todos.push(newTodo);
            renderTodos();
            
            // Show success message
            showNotification('Success', 'Todo added successfully!', 'success');
            
            // Close modal
            $('#addTodoModal').modal('hide');
            
            // Reset form
            document.getElementById('addTodoForm').reset();
        }
        
        // Toggle todo status
        function toggleTodoStatus(id) {
            const todo = todos.find(t => t.id === id);
            if (todo) {
                todo.completed = todo.completed === 'Yes' ? 'No' : 'Yes';
                renderTodos();
                
                showNotification('Status Updated', `Todo marked as ${todo.completed === 'Yes' ? 'completed' : 'pending'}`, 'info');
            }
        }
        
        // Delete a todo
        function deleteTodo(id) {
            if (confirm('Are you sure you want to delete this todo?')) {
                todos = todos.filter(t => t.id !== id);
                renderTodos();
                
                showNotification('Deleted', 'Todo deleted successfully!', 'info');
            }
        }
        
        // Filter todos
        function filterTodos() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const dueDateFilter = document.getElementById('dueDateFilter').value;
            const overdueFilter = document.getElementById('overdueFilter').checked;
            
            const rows = document.querySelectorAll('#todoTableBody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                if (row.cells.length === 1) return; // Skip the "no todos" row
                
                const todoItem = row.getAttribute('data-todo-item').toLowerCase();
                const status = row.getAttribute('data-status');
                const priority = row.getAttribute('data-priority');
                const category = row.getAttribute('data-category');
                const dueDate = row.getAttribute('data-due-date');
                
                let matchesSearch = searchText === '' || todoItem.includes(searchText);
                let matchesStatus = statusFilter === 'all' || status === statusFilter;
                let matchesPriority = priorityFilter === 'all' || priority === priorityFilter;
                let matchesCategory = categoryFilter === 'all' || category === categoryFilter;
                let matchesDueDate = dueDateFilter === '' || dueDateMatchesFilter(dueDate, dueDateFilter);
                let matchesOverdue = !overdueFilter || isOverdue(dueDate, status);
                
                if (matchesSearch && matchesStatus && matchesPriority && matchesCategory && matchesDueDate && matchesOverdue) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update the todo count
            document.getElementById('todoCount').textContent = visibleCount + ' items';
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('priorityFilter').value = 'all';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('dueDateFilter').value = '';
            document.getElementById('overdueFilter').checked = false;
            
            filterTodos();
        }
        
        // Update the print date
        function updatePrintDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('printDate').textContent = now.toLocaleDateString('en-US', options);
        }
        
        // Print function
        function printTodos() {
            updatePrintDate();
            window.print();
        }
        
        // Check if due date matches the filter
        function dueDateMatchesFilter(dueDate, filterValue) {
            if (!dueDate || dueDate === 'null') return false;
            
            try {
                const dates = filterValue.split(' to ');
                const dueDateObj = new Date(dueDate);
                
                if (dates.length === 1) {
                    // Single date
                    const filterDate = new Date(dates[0]);
                    return dueDateObj.toDateString() === filterDate.toDateString();
                } else if (dates.length === 2) {
                    // Date range
                    const startDate = new Date(dates[0]);
                    const endDate = new Date(dates[1]);
                    endDate.setHours(23, 59, 59, 999); // End of the day
                    return dueDateObj >= startDate && dueDateObj <= endDate;
                }
            } catch (e) {
                console.error('Error parsing dates:', e);
            }
            
            return false;
        }
        
        // Check if a todo is overdue
        function isOverdue(dueDate, status) {
            if (status === 'Yes' || !dueDate || dueDate === 'null') return false;
            
            try {
                const dueDateObj = new Date(dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return dueDateObj < today;
            } catch (e) {
                console.error('Error checking overdue:', e);
                return false;
            }
        }
        
        // Improved Notification function
        function showNotification(title, message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification-item alert-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <p class="notification-message">${message}</p>
                </div>
                <button type="button" class="notification-close" onclick="this.parentElement.remove(); updateNotificationContainer()">
                    &times;
                </button>
            `;
            
            // Add to notification container
            document.getElementById('notificationContainer').appendChild(notification);
            
            // Update container visibility
            updateNotificationContainer();
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                    updateNotificationContainer();
                }
            }, 5000);
        }

        // Update notification container visibility
        function updateNotificationContainer() {
            const container = document.getElementById('notificationContainer');
            if (container.children.length > 0) {
                container.classList.add('has-notifications');
            } else {
                container.classList.remove('has-notifications');
            }
        }

        // Check for overdue todos periodically
        function checkForOverdueTodos() {
            const now = new Date();
            let hasOverdue = false;
            
            todos.forEach(todo => {
                const dueDateStr = todo.dueDate;
                const status = todo.completed;
                const todoItem = todo.todoItem;
                
                if (status === 'No' && dueDateStr) {
                    try {
                        const dueDate = new Date(dueDateStr);
                        if (dueDate < now) {
                            // This todo is overdue
                            hasOverdue = true;
                            const formattedDate = dueDate.toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric', 
                                year: 'numeric' 
                            });
                            
                            showNotification(
                                'Overdue Todo',
                                `"${todoItem}" was due on ${formattedDate}`,
                                'danger'
                            );
                        }
                    } catch (e) {
                        console.error('Error parsing date:', e);
                    }
                }
            });
            
            return hasOverdue;
        }

        // Update pending count
        function updatePendingCount() {
            const pendingCount = todos.filter(todo => todo.completed === 'No').length;
            
            // Show notification only if there are pending todos
            if (pendingCount > 0) {
                showNotification(
                    'Pending Todos', 
                    `You have ${pendingCount} pending todo${pendingCount !== 1 ? 's' : ''} to complete`, 
                    'warning'
                );
            }
        }

        // Initialize notifications
        function initNotifications() {
            // Check for overdue todos on page load
            checkForOverdueTodos();
            
            // Check for overdue todos every minute
            setInterval(checkForOverdueTodos, 60000);
        }

        // Add event listener for beforeprint to update the date
        window.addEventListener('beforeprint', updatePrintDate);
    </script>
</body>
</html>